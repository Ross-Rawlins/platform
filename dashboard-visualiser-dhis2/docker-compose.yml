version: "3.9"

services:
  dashboard-visualiser-dhis2:
    image: "dhis2/core:2.38.4.3"
    environment:
      JAVA_OPTS: "-agentlib:jdwp=transport=dt_socket,server=y,suspend=n \
                -Dlog4j2.configurationFile=/opt/dhis2/log4j2.xml
                -Dcom.sun.management.jmxremote \
                -Dcom.sun.management.jmxremote.local.only=false \
                -Dcom.sun.management.jmxremote.authenticate=false \
                -Dcom.sun.management.jmxremote.ssl=false"
    deploy:
      replicas: ${DHIS_INSTANCES}
      placement:
        max_replicas_per_node: 1
      resources:
        limits:
          cpus: ${DHIS_CPU_LIMIT}
          memory: ${DHIS_MEMORY_LIMIT}
        reservations:
          cpus: ${DHIS_CPU_RESERVE}
          memory: ${DHIS_MEMORY_RESERVE}
    configs:
      - target: /opt/dhis2/dhis.conf
        source: dhis2-dhis.conf
      - target: /opt/dhis2/log4j2.xml
        source: dhis2-log4j2.xml
    networks:
      dhis-public:
      dhis-postgres:
    depends_on:
      - dhis-postgres-1

configs:
  dhis2-dhis.conf:
    file: ./dhis.conf
    name: dhis.conf-${dhis2_dhis_conf_DIGEST:?err}
    labels: 
      name: dhis
  dhis2-log4j2.xml:
    file: ./log4j2.xml
    name: log4j2.xml-${dhis2_log4j2_xml_DIGEST:?err}
    labels: 
      name: dhis

networks:
  dhis-public:
    name: dhis2-public
    external: true
