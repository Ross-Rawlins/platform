{
  "name": "Search Endpoint deterministic",
  "endpoint": {
    "pattern": "/fhir/Patient",
    "method": "GET"
  },
  "transformation": {
    "output": "JSON"
  },
  "inputTransforms": {
    "total": "$count(lookupRequests.jempiSearchAll.data.goldenRecords)",
    "entry": "$map(lookupRequests.jempiSearchAll.data.goldenRecords, function($v) {{'resource': {'resourceType': 'Patient', 'name': {'given': [$v.demographicData.givenName, $v.demographicData.middleName],'family': $v.demographicData.familyName, 'prefix': [$v.demographicData.prefixName]},'address': [{'type': $v.demographicData.addressType, 'line': [$v.demographicData.addressNumber, $v.demographicData.addressStreet],'city': $v.demographicData.addressCity, 'district': $v.demographicData.addressDistrict, 'state': $v.demographicData.addressState, 'postalCode': $v.demographicData.addressPostalCode, 'country': $v.demographicData.addressCountry}],'birthDate': $v.demographicData.dob,'telecom': [{'system': 'phone','value': $v.demographicData.phoneNumber}, {'system': 'email', 'value': $v.demographicData.emailAddressA}, {'system': 'email', 'value': $v.demographicData.emailAddressB}],'identifier': [{'system': $v.sourceId.facility,'value': $v.sourceId.patient}, {'system': constants.nicSystem,'value': $v.demographicData.nic},{'system': constants.ppnSystem,'value': $v.demographicData.ppn},{'system': constants.scnSystem,'value': $v.demographicData.scn},{'system': constants.dlSystem,'value': $v.demographicData.dl}],'gender': $v.demographicData.gender}}})"
  },
  "inputMapping": {
    "constants.resourceType": "resourceType",
    "constants.type": "type",
    "transforms.total": "total",
    "transforms.entry": "entry"
  },
  "constants": {
    "resourceType": "Bundle",
    "type": "searchset",
    "nicSystem": "http://fhir.health.gov.lk/ips/identifier/nic",
    "ppnSystem": "http://fhir.health.gov.lk/ips/identifier/passport",
    "scnSystem": "http://fhir.health.gov.lk/ips/identifier/scn",
    "dlSystem": "http://fhir.health.gov.lk/ips/identifier/drivers"
  },
  "requests": {
    "lookup": [
      {
        "id": "jempiSearchAll",
        "config": {
          "method": "get",
          "headers": {
            "contentType": "application/json"
          },
          "params": {
            "query": {
              "family": {
                "path": "query.family"
              },
              "given": {
                "path": "query.given"
              },
              "telecom": {
                "path": "query.telecom"
              },
              "identifier": {
                "path": "query.identifier"
              },
              "gender": {
                "path": "query.gender"
              },
              "birthDate": {
                "path": "query.birthDate"
              },
              "address": {
                "path": "query.address"
              }
            }
          },
          "url": "http://openhim-mapping-mediator:3003/search-response"
        }
      }
    ]
  }
}
