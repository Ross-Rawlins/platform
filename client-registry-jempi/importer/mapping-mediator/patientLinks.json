{
  "name": "Get patient links",
  "endpoint": {
    "pattern": "/fhir/links/Patient/:patientId",
    "method": "GET"
  },
  "transformation": {
    "input": "JSON",
    "output": "JSON"
  },
  "inputTransforms": {
    "id": "lookupRequests.jempiSearch.data.goldenRecord.uid",
    "gender": "$exists(lookupRequests.jempiSearch.data.goldenRecord.demographicData.gender) ? lookupRequests.jempiSearch.data.goldenRecord.demographicData.gender : null",
    "birthDate": "$exists(lookupRequests.jempiSearch.data.goldenRecord.demographicData.dob) ? lookupRequests.jempiSearch.data.goldenRecord.demographicData.dob : null",
    "prefixName": "$exists(lookupRequests.jempiSearch.data.goldenRecord.demographicData.prefixName) ? lookupRequests.jempiSearch.data.goldenRecord.demographicData.prefixName : null",
    "givenName": "$exists(lookupRequests.jempiSearch.data.goldenRecord.demographicData.givenName) ? lookupRequests.jempiSearch.data.goldenRecord.demographicData.givenName : null",
    "middleName": "$exists(lookupRequests.jempiSearch.data.goldenRecord.demographicData.middleName) ? lookupRequests.jempiSearch.data.goldenRecord.demographicData.middleName : null",
    "familyName": "$exists(lookupRequests.jempiSearch.data.goldenRecord.demographicData.familyName) ? lookupRequests.jempiSearch.data.goldenRecord.demographicData.familyName : null",
    "addressType": "$exists(lookupRequests.jempiSearch.data.goldenRecord.demographicData.addressType) ? lookupRequests.jempiSearch.data.goldenRecord.demographicData.addressType : null",
    "addressNumber": "$exists(lookupRequests.jempiSearch.data.goldenRecord.demographicData.addressNumber) ? lookupRequests.jempiSearch.data.goldenRecord.demographicData.addressNumber : null",
    "addressStreet": "$exists(lookupRequests.jempiSearch.data.goldenRecord.demographicData.addressStreet) ? lookupRequests.jempiSearch.data.goldenRecord.demographicData.addressStreet : null",
    "addressCity": "$exists(lookupRequests.jempiSearch.data.goldenRecord.demographicData.addressCity) ? lookupRequests.jempiSearch.data.goldenRecord.demographicData.addressCity : null",
    "addressDistrict": "$exists(lookupRequests.jempiSearch.data.goldenRecord.demographicData.addressDistrict) ? lookupRequests.jempiSearch.data.goldenRecord.demographicData.addressDistrict : null",
    "addressState": "$exists(lookupRequests.jempiSearch.data.goldenRecord.demographicData.addressState) ? lookupRequests.jempiSearch.data.goldenRecord.demographicData.addressState : null",
    "addressPostalCode": "$exists(lookupRequests.jempiSearch.data.goldenRecord.demographicData.addressPostalCode) ? lookupRequests.jempiSearch.data.goldenRecord.demographicData.addressPostalCode : null",
    "addressCountry": "$exists(lookupRequests.jempiSearch.data.goldenRecord.demographicData.addressCountry) ? lookupRequests.jempiSearch.data.goldenRecord.demographicData.addressCountry : null",
    "identifierValue": "$exists(lookupRequests.jempiSearch.data.goldenRecord.sourceId) and $exists(lookupRequests.jempiSearch.data.goldenRecord.sourceId.patient) ? lookupRequests.jempiSearch.data.goldenRecord.sourceId.patient : null",
    "identifierSystem": "$exists(lookupRequests.jempiSearch.data.goldenRecord.sourceId) and $exists(lookupRequests.jempiSearch.data.goldenRecord.sourceId.facility) ? lookupRequests.jempiSearch.data.goldenRecord.sourceId.facility : null",
    "nic": "$exists(lookupRequests.jempiSearch.data.goldenRecord.demographicData.nic) ? {'type': {'coding': [{'system': constants.fhirCodingSystem, 'code': 'NIC' }], 'text': 'National identity number'}, 'system': constants.nicSystem, 'value': lookupRequests.jempiSearch.data.goldenRecord.demographicData.nic} : null",
    "ppn": "$exists(lookupRequests.jempiSearch.data.goldenRecord.demographicData.ppn) ? {'type': {'coding': [{'system': constants.terminologyCodingSystem, 'code': 'PPN' }], 'text': 'Passport number'}, 'system': constants.ppnSystem, 'value': lookupRequests.jempiSearch.data.goldenRecord.demographicData.ppn} : null",
    "scn": "$exists(lookupRequests.jempiSearch.data.goldenRecord.demographicData.scn) ? {'type': {'coding': [{'system': constants.fhirCodingSystem, 'code': 'SCN' }], 'text': 'Senior Citizen Number'}, 'system': constants.scnSystem, 'value': lookupRequests.jempiSearch.data.goldenRecord.demographicData.scn} : null",
    "dl": "$exists(lookupRequests.jempiSearch.data.goldenRecord.demographicData.dl) ? {'type': {'coding': [{'system': constants.terminologyCodingSystem, 'code': 'DL' }], 'text': 'Drivers license number'}, 'system': constants.dlSystem, 'value': lookupRequests.jempiSearch.data.goldenRecord.demographicData.dl} : null",
    "phoneNumber": "$exists(lookupRequests.jempiSearch.data.goldenRecord.demographicData.phoneNumber) ? {'value': lookupRequests.jempiSearch.data.goldenRecord.demographicData.phoneNumber, 'system': constants.phone} : null",
    "emailAddress": "$exists(lookupRequests.jempiSearch.data.goldenRecord.demographicData.emailAddress) ? {'value': lookupRequests.jempiSearch.data.goldenRecord.demographicData.emailAddress, 'system': constants.email} : null",
    "link": "$append([], $map(lookupRequests.jempiSearch.data.interactionsWithScore, function($v) {{'other': {'reference': 'Patient/' & $v.interaction.uid}, 'type': 'refer'}}))"
  },
  "inputMapping": {
    "constants.resourceType": "resourceType",
    "transforms.id": "id",
    "transforms.gender": "gender",
    "transforms.birthDate": "birthDate",
    "transforms.familyName": "name[0].family",
    "transforms.givenName": "name[0].given[0]",
    "transforms.middleName": "name[0].given[1]",
    "transforms.prefixName": "name[0].prefix[0]",
    "transforms.addressType": "address[0].type",
    "transforms.addressNumber": "address[0].line[0]",
    "transforms.addressStreet": "address[0].line[1]",
    "transforms.addressCity": "address[0].city",
    "transforms.addressDistrict": "address[0].district",
    "transforms.addressState": "address[0].state",
    "transforms.addressPostalCode": "address[0].postalCode",
    "transforms.addressCountry": "address[0].country",
    "transforms.identifierSystem": "identifier[0].system",
    "transforms.identifierValue": "identifier[0].value",
    "transforms.nic": "identifier[]+",
    "transforms.ppn": "identifier[]+",
    "transforms.scn": "identifier[]+",
    "transforms.dl": "identifier[]+",
    "transforms.phoneNumber": "telecom[]+",
    "transforms.emailAddress": "telecom[]+",
    "transforms.link": "link"
  },
  "constants": {
    "fhirCodingSystem": "http://fhir.health.gov.lk/ips/CodeSystem/cs-identifier-types",
    "terminologyCodingSystem": "http://terminology.hl7.org/CodeSystem/v2-0203",
    "nicSystem": "http://fhir.health.gov.lk/ips/identifier/nic",
    "ppnSystem": "http://fhir.health.gov.lk/ips/identifier/passport",
    "scnSystem": "http://fhir.health.gov.lk/ips/identifier/scn",
    "dlSystem": "http://fhir.health.gov.lk/ips/identifier/drivers",
    "resourceType": "Patient",
    "phone": "phone",
    "email": "email"
  },
  "requests": {
    "lookup": {
      "id": "jempiSearch",
      "config": {
        "method": "get",
        "url": "http://openhim-mapping-mediator:3003/response/links/:patientId",
        "params": {
          "url": {
            "patientId": {
              "path": "urlParams.patientId"
            }
          }
        }
      }
    }
  }
}
